# Today I Learned

> 2025년 04월 22일 임태호

# 데모계정 삭제 스케줄 이슈

## 첫 번째 시도

- 데모 계정 생성 후 1시간 뒤에 동작하는 데모 계정 삭제 Batch를 TaskScheduler에 등록하면 되지 않을까? → 로컬에서는 정상 작동함
- 근데, 프로덕션에서는 WAS가 기본 2대 작동되고 트래픽이 몰리면 자동으로 스케일아웃해서 WAS가 더더욱 늘어남.
- 스케일아웃 된 WAS에서 스케줄 등록 후 그 WAS가 다시 스케일인 되면?? 데모 계정 삭제 Batch 스케줄이 날라가는 문제 발생

## 문제 상황

**3번째 WAS에서 데모계정생성 -> 3번째 WAS 사라짐(스케일인) -> 1시간 뒤에 데모 계정 삭제 스케줄 동작하려 했으나 3번째 WAS가 없어서 동작하지 못함**
결과적으로, 데모계정 삭제가 안되는 문제 발생

## 내가 생각한 해결 방안 ↓

### 1. 레디스에 데모계정 memberId 저장하고 TTL로 1시간 설정

- 장점: WAS 종료 후 재시작 되어도 데모계정 삭제 로직 동작 가능

- 단점: 레디스 -> 서버로 memberId 정보를 보낼 수 없고 서버가 주기적으로 레디스에 memberId를 확인해야 함 (예를 들어, 1분 주기로 레디스 체크)

### 2. 데모계정 전용 WAS 구축하고 스케일 인/아웃 적용하지 않기

- 아직 감이 안옴
- 종우형 고생길 예약

## 🛠 GPT가 제시한 해결 방안 ↓

### 1. **스케줄 관리의 중앙 집중화 (추천)**

- **문제 원인**: 스케줄이 개별 WAS 인스턴스 내부에 설정되어 있어서 인스턴스가 사라지면 스케줄도 함께 소멸.
- **해결책**: 스케줄을 중앙에서 관리되도록 하여 인스턴스 수명과 무관하게 스케줄이 유지되도록 함.

**구현 방식 예시:**

- **스케줄 관리 DB 테이블 + 배치 서버/전용 서비스**
    - 데모 계정 생성 시 DB에 삭제 예정 정보 저장 (예: `delete_at` 타임스탬프)
    - 별도의 **스케줄러 서버** 혹은 **Spring Batch, Quartz Scheduler** 등에서 DB를 주기적으로 조회하여 삭제 작업 수행
    - 이 스케줄러는 WAS 인스턴스와 별개로 구성 (예: Kubernetes CronJob, 독립 배치 서버)

> ✅ 장점: 인스턴스 수와 관계없이 안정적이며, 확장성과 유지보수 측면에서 우수
> 

---

### 2. **분산 스케줄러 사용**

- Redis 기반의 **분산 락(distributed lock)**을 사용해 여러 WAS 중 **한 곳만 특정 스케줄을 실행**하게 설정

**기술 예시:**

- `ShedLock` + `Spring Scheduler` + Redis or DB
    - 여러 인스턴스에서 스케줄이 실행되지만, **분산 락을 통해 오직 하나의 인스턴스만 실제 작업 수행**

> ⚠️ 단점: 여전히 스케줄 코드가 WAS 안에 있으므로, WAS가 완전히 종료되면 문제가 될 수 있음. 그러나 빈자리를 다른 인스턴스가 이어받을 수 있다는 점에서 위 문제는 완화됨.
> 

---

### 3. **서버리스 아키텍처 사용 (Lambda, Cloud Function 등)**

- 데모 계정 생성 시 → 일정 시간이 지난 후 실행될 **서버리스 함수 예약**
- 예: AWS Lambda + EventBridge / Google Cloud Task 사용

> 장점: 스케줄과 실행이 완전히 클라우드에 의해 관리되므로, 인스턴스 수명과 무관
> 
> 
> 단점: 클라우드 종속성 증가, 사내 인프라에서는 도입 어려움
>

## 결론
- 내가 생각한 1번 해결 방안에서 종우형 아이디어를 추가해 문제 해결함
- 데모 계정 일괄 삭제 API 하나 만들었음
- Redis에 데모 계정 생성 시 데모 memberId를 key로 넣고 TTL을 1시간으로 설정
- 데모 계정 일괄 삭제 API가 호출되면, Redis에 있는 데모 계정들은 삭제하지 않고, Redis에 없는 데모 계정들은 일괄 삭제 처리 (데모계정 생성 후 1시간이 지난 것들 일괄 삭제)
- Gitlab Runner 또는 Github actions로 특정 주기(ex. 5분)에 한 번씩 데모 계정 일괄 삭제 API 호출
- 이렇게 하는 경우, WAS가 여러 대여도 API 호출 시, ELB가 하나의 WAS만 동작시키므로 문제 없음!